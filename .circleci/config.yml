version: 2
jobs:
  build:
    docker:
      - image: rust:1.37-stretch
    steps:
      - checkout
      - restore_cache:
          key: rust-cache
      - run:
          name: Build and test
          command: |
            echo $CARGO_HOME
            rustup component add rustfmt-preview
            cargo fmt -- --check
            cargo build
            cargo test
      - run:
          name: Release build
          command: >
            OPENSSL_STATIC=1 OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu OPENSSL_INCLUDE_DIR=/usr/include/openssl
            cargo build --release
      - persist_to_workspace:
          root: .
          paths:
            - target/release
      - save_cache:
          key: rust-cache
          paths:
            - "/usr/local/cargo"
            - "./target"
  deploy:
    docker:
      - image: rust:1.37-stretch
    steps:
      - attach_workspace:
          at: .
      - add_ssh_keys:
          fingerprints:
            - "45:16:fd:9e:94:b8:84:59:ae:5b:50:6e:e7:e2:e5:09"
      - run:
          name: Add fingerprint
          command: echo $UPDATE_FINGERPRINT >> ~/.ssh/known_hosts
      - run:
          name: Deploy
          command: |
            scp ./target/release/epg-server $USERNAME@$HOST:~/epg-server.tmp
            ssh $USERNAME@$HOST mv epg-server.tmp epg-server
            ssh $USERNAME@$HOST sudo /bin/systemctl restart epg-server-soveni epg-server-king
  mirror:
    docker:
      - image: circleci/python
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "19:db:1c:7a:53:a2:a6:7f:c4:3b:9b:57:de:5a:ee:d6"
      - run:
          name: GitHub mirror
          command: |
            git remote add github git@github.com:technic/epg-server.git
            git push --mirror github

workflows:
  version: 2
  main:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only:
                - master
      - mirror:
          filters:
            branches:
              only:
                - master
